<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeerJS Chat App</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #e0e7ff, #f3e8ff);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-container {
            width: 90%;
            max-width: 900px;
            margin: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background: linear-gradient(90deg, #075e54, #128c7e);
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-size: clamp(1.2em, 4vw, 1.5em);
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        #username-input {
            padding: 8px;
            border: none;
            border-radius: 5px;
            font-size: clamp(0.9em, 3vw, 1em);
            width: 100%;
            max-width: 200px;
            margin: 5px 0;
        }
        .chat-messages {
            flex: 1;
            max-height: 50vh;
            overflow-y: auto;
            padding: 15px;
            background: #f9f9f9;
        }
        .message {
            margin: 8px 0;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            animation: slideIn 0.3s ease;
            font-size: clamp(0.9em, 3vw, 1em);
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .sent {
            background: #dcf8c6;
            margin-left: auto;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .received {
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .chat-input {
            display: flex;
            padding: 10px;
            background: #fff;
            border-top: 1px solid #e0e0e0;
        }
        #message-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 8px;
            font-size: clamp(0.9em, 3vw, 1em);
            transition: border-color 0.3s;
        }
        #message-input:focus {
            border-color: #075e54;
            outline: none;
        }
        #send-button {
            padding: 10px 15px;
            background: #075e54;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }
        #send-button:hover {
            background: #054d44;
        }
        .status {
            padding: 8px;
            text-align: center;
            color: #555;
            font-size: clamp(0.8em, 2.5vw, 0.9em);
            background: #f0f0f0;
        }
        .connection-controls {
            padding: 15px;
            background: #fff;
            border-top: 1px solid #e0e0e0;
        }
        .connection-controls label {
            display: block;
            margin: 8px 0 4px;
            color: #333;
            font-weight: 500;
            font-size: clamp(0.9em, 3vw, 1em);
        }
        #peer-id, #remote-id, #peer-name {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: clamp(0.9em, 3vw, 1em);
            margin-bottom: 5px;
        }
        #copy-button, #connect-button, #disconnect-button {
            padding: 8px;
            margin: 5px 5px 0 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }
        #copy-button {
            background: #4CAF50;
            color: white;
        }
        #copy-button:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        #connect-button {
            background: #2196F3;
            color: white;
        }
        #connect-button:hover {
            background: #1976D2;
            transform: scale(1.05);
        }
        #disconnect-button {
            background: #f44336;
            color: white;
            display: none;
        }
        #disconnect-button:hover {
            background: #d32f2f;
            transform: scale(1.05);
        }
        #peer-list {
            max-height: 20vh;
            overflow-y: auto;
            margin: 10px 0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            background: #fafafa;
        }
        .peer-item {
            cursor: pointer;
            padding: 6px;
            border-radius: 5px;
            transition: background 0.2s;
            font-size: clamp(0.9em, 3vw, 1em);
        }
        .peer-item.online {
            color: #2e7d32;
        }
        .peer-item.offline {
            color: #d32f2f;
        }
        .peer-item:hover {
            background: #e0f7fa;
        }
        @media (max-width: 600px) {
            .chat-container {
                margin: 10px;
            }
            .chat-header {
                padding: 8px 10px;
                flex-direction: column;
            }
            #username-input {
                width: 100%;
                max-width: none;
            }
            .chat-messages {
                padding: 10px;
            }
            .chat-input {
                padding: 8px;
            }
            #message-input {
                margin-right: 5px;
            }
            #send-button {
                padding: 8px 12px;
            }
            .connection-controls {
                padding: 10px;
            }
            #peer-id, #remote-id, #peer-name {
                max-width: none;
            }
            #copy-button, #connect-button, #disconnect-button {
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h2>PeerJS Chat</h2>
            <input type="text" id="username-input" placeholder="Set your username">
        </div>
        <div class="status" id="status">Initializing...</div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="message-input" placeholder="Type a message...">
            <button id="send-button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
        <div class="connection-controls">
            <label>Your Peer ID: <input type="text" id="peer-id" readonly></label>
            <button id="copy-button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            </button><br>
            <label>Connect to ID: <input type="text" id="remote-id" placeholder="Enter other user's Peer ID"></label>
            <label>Name: <input type="text" id="peer-name" placeholder="Enter a name for this peer"></label>
            <button id="connect-button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07L1.71 14.29a1 1 0 0 0 0 1.42l7.07 7.07a1 1 0 0 0 1.42 0L22.29 10.71"></path>
                </svg>
            </button>
            <button id="disconnect-button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M10 14 2 22m20-20L10 14"></path>
                </svg>
            </button>
            <div id="peer-list"></div>
        </div>
    </div>

    <!-- PeerJS Library -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        // DOM elements
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const status = document.getElementById('status');
        const peerIdInput = document.getElementById('peer-id');
        const remoteIdInput = document.getElementById('remote-id');
        const peerNameInput = document.getElementById('peer-name');
        const connectButton = document.getElementById('connect-button');
        const disconnectButton = document.getElementById('disconnect-button');
        const copyButton = document.getElementById('copy-button');
        const peerList = document.getElementById('peer-list');
        const usernameInput = document.getElementById('username-input');

        // Load or set username from localStorage
        let currentUser = localStorage.getItem('chatUsername') || '';
        if (!currentUser) {
            currentUser = `User_${Math.random().toString(36).substr(2, 5)}`;
            localStorage.setItem('chatUsername', currentUser);
        }
        usernameInput.value = currentUser;

        // Load messages from localStorage
        let messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
        let peer;
        let conn;
        let isPeerActive = false; // Tracks if this user's PeerJS is active
        let peerStatus = {}; // Tracks peer online status

        // Encode text to prevent XSS
        function encodeHTML(text) {
            return text
                .replace(/&/g, '&')
                .replace(/</g, '<')
                .replace(/>/g, '>')
                .replace(/"/g, '"')
                .replace(/'/g, ''');
        }

        // Update username on input change
        usernameInput.addEventListener('change', () => {
            currentUser = encodeHTML(usernameInput.value.trim()) || `User_${Math.random().toString(36).substr(2, 5)}`;
            localStorage.setItem('chatUsername', currentUser);
            addMessage(`Username updated to "${currentUser}"`, 'System', false);
        });

        // Load or generate persistent PeerJS ID
        let myPeerId = localStorage.getItem('myPeerId');
        if (!myPeerId) {
            myPeerId = `${Math.random().toString(36).substr(2, 9)}-${Date.now()}`;
            localStorage.setItem('myPeerId', myPeerId);
        }

        // Load peer list from localStorage
        let knownPeers = JSON.parse(localStorage.getItem('knownPeers')) || {};

        // Add message to chat and localStorage
        function addMessage(text, sender, isSent) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(isSent ? 'sent' : 'received');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messageDiv.innerHTML = `<strong>${encodeHTML(sender)}</strong> (${encodeHTML(time)}): ${encodeHTML(text)}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            messages.push({ text, sender, time, isSent });
            localStorage.setItem('chatMessages', JSON.stringify(messages));
        }

        // Load existing messages
        function loadMessages() {
            messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
            chatMessages.innerHTML = '';
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');
                messageDiv.classList.add(msg.isSent ? 'sent' : 'received');
                messageDiv.innerHTML = `<strong>${encodeHTML(msg.sender)}</strong> (${encodeHTML(msg.time)}): ${encodeHTML(msg.text)}`;
                chatMessages.appendChild(messageDiv);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message
        function sendMessage() {
            const text = messageInput.value.trim();
            if (text) {
                if (isPeerActive && conn && conn.open) {
                    conn.send(JSON.stringify({ sender: currentUser, text }));
                    addMessage(text, currentUser, true);
                } else {
                    addMessage(text, currentUser, true); // Save locally
                    if (!isPeerActive) {
                        addMessage('You are offline. Message saved locally.', 'System', false);
                    } else if (!conn || !conn.open) {
                        addMessage('Not connected to a peer. Message saved locally.', 'System', false);
                    }
                }
                messageInput.value = '';
            }
        }

        // Update peer list UI with online status
        function updatePeerList() {
            peerList.innerHTML = '';
            for (const [id, name] of Object.entries(knownPeers)) {
                const peerItem = document.createElement('div');
                peerItem.classList.add('peer-item');
                peerItem.classList.add(peerStatus[id] ? 'online' : 'offline');
                peerItem.innerHTML = `${encodeHTML(name)} (${encodeHTML(id)}) - ${peerStatus[id] ? 'Online' : 'Offline'}`;
                peerItem.addEventListener('click', () => {
                    remoteIdInput.value = id;
                    peerNameInput.value = name;
                    connectButton.click();
                });
                peerList.appendChild(peerItem);
            }
        }

        // Check peer online status
        function checkPeerStatus() {
            if (!isPeerActive || !peer) return;
            for (const id in knownPeers) {
                if (id !== myPeerId && (!conn || conn.peer !== id)) {
                    const tempConn = peer.connect(id, { metadata: { name: currentUser, ping: true } });
                    tempConn.on('open', () => {
                        peerStatus[id] = true;
                        tempConn.close();
                        updatePeerList();
                    });
                    tempConn.on('error', () => {
                        peerStatus[id] = false;
                        updatePeerList();
                    });
                } else if (conn && conn.peer === id && conn.open) {
                    peerStatus[id] = true;
                } else {
                    peerStatus[id] = false;
                }
            }
        }

        // Update status based on PeerJS activity
        function updateStatus() {
            status.textContent = isPeerActive ? 'Online' : 'Offline';
            connectButton.disabled = !isPeerActive || (conn && conn.open);
            disconnectButton.style.display = (isPeerActive && conn && conn.open) ? 'inline-block' : 'none';
            messageInput.disabled = false; // Always allow input
            sendButton.disabled = false; // Always allow sending (saves locally if offline)
            if (!isPeerActive) {
                addMessage('You are offline. You can still write messages to save locally.', 'System', false);
            } else {
                addMessage('You are online! Share your Peer ID to chat.', 'System', false);
                checkPeerStatus();
            }
        }

        // Initialize PeerJS
        peer = new Peer(myPeerId);
        peer.on('open', (id) => {
            isPeerActive = true;
            peerIdInput.value = id;
            updateStatus();
            loadMessages();
            updatePeerList();
            setInterval(checkPeerStatus, 30000); // Check every 30 seconds
        });

        peer.on('disconnected', () => {
            isPeerActive = false;
            if (conn) conn.close();
            conn = null;
            updateStatus();
        });

        peer.on('close', () => {
            isPeerActive = false;
            if (conn) conn.close();
            conn = null;
            updateStatus();
        });

        peer.on('error', (err) => {
            console.error('PeerJS error:', err);
            if (err.type === 'disconnected' || err.type === 'peer-unavailable') {
                isPeerActive = false;
                updateStatus();
            }
            addMessage('Connection error: ' + err.type, 'System', false);
        });

        // Handle incoming connections
        peer.on('connection', (connection) => {
            if (connection.metadata?.ping) {
                peerStatus[connection.peer] = true;
                connection.close();
                updatePeerList();
                return;
            }
            conn = connection;
            setupConnection();
            const peerName = conn.metadata?.name || 'Unknown';
            knownPeers[conn.peer] = peerName;
            localStorage.setItem('knownPeers', JSON.stringify(knownPeers));
            updatePeerList();
            addMessage(`Incoming connection from ${peerName} (${conn.peer})`, 'System', false);
        });

        // Connect to another peer
        connectButton.addEventListener('click', () => {
            if (!isPeerActive) {
                addMessage('Cannot connect while offline.', 'System', false);
                return;
            }
            const remoteId = remoteIdInput.value.trim();
            const peerName = encodeHTML(peerNameInput.value.trim()) || 'Unknown';
            if (remoteId && remoteId !== myPeerId) {
                conn = peer.connect(remoteId, { metadata: { name: currentUser } });
                if (!knownPeers[remoteId] || knownPeers[remoteId] === 'Unknown') {
                    knownPeers[remoteId] = peerName;
                }
                localStorage.setItem('knownPeers', JSON.stringify(knownPeers));
                setupConnection();
                updatePeerList();
            }
        });

        // Disconnect from peer
        disconnectButton.addEventListener('click', () => {
            if (conn && conn.open) {
                conn.close();
                status.textContent = 'Online';
                messageInput.disabled = false;
                sendButton.disabled = false;
                connectButton.disabled = false;
                disconnectButton.style.display = 'none';
                addMessage('You disconnected from the peer', 'System', false);
                checkPeerStatus();
            }
        });

        // Setup connection handlers
        function setupConnection() {
            conn.on('open', () => {
                status.textContent = 'Connected to ' + conn.peer;
                messageInput.disabled = false;
                sendButton.disabled = false;
                connectButton.disabled = true;
                disconnectButton.style.display = 'inline-block';
                addMessage('Connected to peer!', 'System', false);
                peerStatus[conn.peer] = true;
                updatePeerList();
                if (conn.metadata?.name) {
                    knownPeers[conn.peer] = conn.metadata.name;
                    localStorage.setItem('knownPeers', JSON.stringify(knownPeers));
                    updatePeerList();
                }
            });

            conn.on('data', (data) => {
                const { sender, text } = JSON.parse(data);
                addMessage(text, sender, false);
            });

            conn.on('close', () => {
                status.textContent = 'Online';
                messageInput.disabled = false;
                sendButton.disabled = false;
                connectButton.disabled = false;
                disconnectButton.style.display = 'none';
                addMessage('Peer disconnected', 'System', false);
                peerStatus[conn.peer] = false;
                updatePeerList();
            });

            conn.on('error', (err) => {
                console.error('Connection error:', err);
                status.textContent = 'Error: ' + err.message;
                peerStatus[conn.peer] = false;
                updatePeerList();
            });
        }

        // Copy Peer ID to clipboard
        copyButton.addEventListener('click', () => {
            peerIdInput.select();
            navigator.clipboard.writeText(peerIdInput.value)
                .then(() => {
                    addMessage('Peer ID copied to clipboard!', 'System', false);
                })
                .catch((err) => {
                    console.error('Failed to copy:', err);
                    addMessage('Failed to copy ID', 'System', false);
                });
        });

        // Event listeners for sending messages
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Handle page visibility or unload to simulate offline
        window.addEventListener('beforeunload', () => {
            if (peer) peer.destroy();
            isPeerActive = false;
        });

        // Initial load
        loadMessages();
    </script>
</body>
</html>
